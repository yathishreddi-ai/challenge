<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Smart Safe Dashboard</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; background: #f5f7fa; }
    header { background: #11406d; color: #fff; padding: 1rem 2rem; font-size: 1.6rem; }
    .container { padding: 2rem; }
    #status { margin-top: 1rem; font-weight: bold; }
    video { width: 360px; height: 240px; background: #333; border-radius: 6px; }
    .map { width: 360px; height: 200px; margin-top: 1rem; }
    .hospital-info { margin-top: 1rem; background: #fff; padding: 1rem; border-radius: 6px; box-shadow: 0 2px 6px #ddd; }
    button { background: #138b60; color: #fff; border: none; padding: .7rem 1.5rem; border-radius: 5px; font-size: 1rem; cursor: pointer; }
    button:disabled { background: #777; }
  </style>
</head>
<body>
  <header>Smart Safe Accident Reduction Dashboard</header>
  <div class="container">
    <button id="connectBtn">Connect & Start Monitoring</button>
    <div id="status">Status: Waiting to connect...</div>
    <video id="video" autoplay muted></video>
    <div>
      <strong>Live Location:</strong>
      <span id="location">Not detected</span>
    </div>
    <div id="map" class="map"></div>
    <div class="hospital-info">
      <strong>Nearest Hospital:</strong>
      <div id="hospital">No data</div>
      <button id="callHospitalBtn" disabled>Call Hospital</button>
    </div>
  </div>
  <script>
    // Helper: Display status
    function setStatus(msg) { document.getElementById('status').innerText = 'Status: ' + msg; }

    // Camera/mic setup
    let mediaRecorder, stream, chunks = [];
    async function startMedia() {
      try {
        stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
        document.getElementById('video').srcObject = stream;
        mediaRecorder = new MediaRecorder(stream);
        mediaRecorder.ondataavailable = e => chunks.push(e.data);
        mediaRecorder.start();
        setStatus('Recording started. Monitoring...');
      } catch (e) {
        setStatus('Media access denied.');
      }
    }

    // Get location and display + map
    let coords = {lat:null, lng:null};
    function showMap(lat, lng) {
      const mapDiv = document.getElementById('map');
      mapDiv.innerHTML = `<iframe width="100%" height="100%" frameborder="0"
        src="https://www.google.com/maps?q=${lat},${lng}&z=15&output=embed"></iframe>`;
    }
    function getLocationAndHospital() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(async pos => {
          coords.lat = pos.coords.latitude;
          coords.lng = pos.coords.longitude;
          document.getElementById('location').innerText =
            `${coords.lat.toFixed(5)}, ${coords.lng.toFixed(5)}`;
          showMap(coords.lat, coords.lng);
          await fetchNearestHospital(coords.lat, coords.lng);
        });
      } else {
        document.getElementById('location').innerText = 'Geolocation unavailable';
      }
    }

    // Find nearest hospital using Google Places API
    async function fetchNearestHospital(lat, lng) {
      // Needs a Google Places API key for live deployment
      const apiKey = 'YOUR_GOOGLE_PLACES_API_KEY';
      const url =
        `https://maps.googleapis.com/maps/api/place/nearbysearch/json?location=${lat},${lng}&radius=2000&type=hospital&key=${apiKey}`;
      // For demo: display placeholder, as browser can't fetch this API directly due to CORS
      document.getElementById('hospital').innerHTML =
        'City Hospital<br>123 Main St.<br>Phone: 000-000-0000';
      document.getElementById('callHospitalBtn').disabled = false;
      // Uncomment below and use a backend to proxy Google API call for production
      // const resp = await fetch('YOUR_BACKEND_PROXY?lat=' + lat + '&lng=' + lng);
      // const data = await resp.json();
      // Show top result in UI...
    }

    // Bluetooth setup (simulation)
    async function connectBluetoothAndStart() {
      setStatus('Connecting to Smart Safe device...');
      // Here would be the real bluetooth pairing, simulated now:
      setTimeout(() => {
        setStatus('Bluetooth connected!');
        startMedia();
        getLocationAndHospital();
        simulateAccidentDetection();
      }, 2000);
    }

    // Accident detection simulation + emergency actions
    function simulateAccidentDetection() {
      setTimeout(() => {
        setStatus('Accident detected! Notifying hospital...');
        handleEmergency();
      }, 10000); // simulate after 10 seconds
    }
    function handleEmergency() {
      const now = new Date();
      const message = `Accident detected!\nTime: ${now.toLocaleTimeString()} Date: ${now.toLocaleDateString()}\nLocation: ${coords.lat}, ${coords.lng}`;
      // Send SMS/call (would use Twilio or similar via server in production)
      alert('Calling hospital and sending emergency details:\n' + message);
      document.getElementById('callHospitalBtn').disabled = true;
      setStatus('Ambulance notified, message sent with time and coordinates.');
    }

    // Manual call to hospital
    document.getElementById('callHospitalBtn').onclick = handleEmergency;
    document.getElementById('connectBtn').onclick = connectBluetoothAndStart;
  </script>
</body>
</html>
